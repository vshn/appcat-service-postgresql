<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns/website#">
  <head itemscope itemtype="http://schema.org/WebSite">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Decision: Deployment Strategy For PostgreSQL :: AppCat Service PostgreSQL</title>
    <meta property="og:title" itemprop="name" content="Decision: Deployment Strategy For PostgreSQL">
    <meta name="twitter:title" content="Decision: Deployment Strategy For PostgreSQL">
    <link rel="canonical" href="https://vshn.github.io/appcat-service-postgresql/appcat-service-postgresql/explanations/decision-deployment-strategy.html">
    <meta property="og:url" content="https://vshn.github.io/appcat-service-postgresql/appcat-service-postgresql/explanations/decision-deployment-strategy.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="AppCat Service PostgreSQL" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="vshn_ch">
    <meta property="og:locale" content="en_US" />
    <script>var uiRootPath = '../../../_'</script>
    <script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/7105834.js"></script>
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="apple-touch-icon" sizes="152x152" href="/_/img/favicon-152x152.png">
<link rel="apple-touch-icon" sizes="167x167" href="/_/img/favicon-167x167.png">
<link rel="apple-touch-icon" sizes="180x180" href="/_/img/favicon-180x180.png">

<link rel="icon" type="image/png" href="/_/img/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/_/img/favicon-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/_/img/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/_/img/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/_/img/favicon-32x32.png" sizes="32x32">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <div class="vshn_logo"></div>
        <a href="https://vshn.github.io/appcat-service-postgresql">AppCat Service PostgreSQL
           â€“
          v0.0</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">VSHN</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" target="_blank" href="https://www.vshn.ch/">Main website</a>
            <a class="navbar-item" target="_blank" href="https://handbook.vshn.ch/">Handbook</a>
            <a class="navbar-item" target="_blank" href="https://kb.vshn.ch/">Knowledge Base</a>
            <a class="navbar-item" target="_blank" href="https://products.docs.vshn.ch/">Products</a>
            <a class="navbar-item" target="_blank" href="https://legal.docs.vshn.ch/">Legal</a>
            <a class="navbar-item" target="_blank" href="https://control.docs.vshn.ch/">Portal Help</a>
            <a class="navbar-item" target="_blank" href="https://docs.appuio.cloud/">APPUiO Cloud Docs</a>
            <a class="navbar-item" target="_blank" href="https://syn.tools/">Project Syn</a>
            <a class="navbar-item" target="_blank" href="https://k8up.io/">K8up</a>
          </div>
        </div>
        <div class="navbar-item">
          <div class="search-field">
            <input id="search-input" class="search-input" type="search" placeholder="Search">
            <button type="submit" class="search-button">
              <i class="fa fa-search"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="appcat-service-postgresql" data-version="0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">AppCat Service PostgreSQL</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><a href="https://github.com/vshn/appcat-service-postgresql/releases" target="_blank" rel="noopener">Changelog</a> ðŸ”—</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">How To</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../how-tos/create-releases.html">Create Releases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Explanation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Decisions</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="decision-deployment-strategy.html">Deployment Strategy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="decision-usermanagement.html">User And Database Management</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">AppCat Service PostgreSQL</span>
    <span class="version">0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../index.html">AppCat Service PostgreSQL</a>
      <ul class="versions">
        <li class="version">
          <a href="../../0.1/index.html">0.1-rc3</a>
        </li>
        <li class="version is-latest">
          <a href="../../index.html">master</a>
        </li>
        <li class="version is-current">
          <a href="../index.html">0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">AppCat Service PostgreSQL</a></li>
    <li>Explanation</li>
    <li>Decisions</li>
    <li><a href="decision-deployment-strategy.html">Deployment Strategy</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">0.0</button>
  <div class="version-menu">
    <a class="version" href="../../0.1/explanations/decision-deployment-strategy.html">0.1-rc3</a>
    <a class="version" href="../../explanations/decision-deployment-strategy.html">master</a>
    <a class="version is-current" href="decision-deployment-strategy.html">0.0</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/vshn/appcat-service-postgresql/edit/docs/v0.0/docs/modules/ROOT/pages/explanations/decision-deployment-strategy.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Decision: Deployment Strategy For PostgreSQL</h1>
<div class="sect1">
<h2 id="_problem"><a class="anchor" href="#_problem"></a>Problem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When it comes to the actual deployment of a PostgreSQL instance, there are different options to choose from, each with their (dis)advantages.
The options chosen must be ready to deal with "parent decisions" that have different impact depending on the option chosen.
See the background section for more details.</p>
</div>
<div class="paragraph">
<p>This decision is essentially a "make or buy" decision.</p>
</div>
<div class="paragraph">
<p>"Buying" means using upstream software for less engineering effort at the risk of encountering and dealing with upstream breaking changes (although there&#8217;s still the integration effort).
"Making" means more engineering effort on VSHN&#8217;s end but any changes are under VSHN&#8217;s control.</p>
</div>
<div class="sect2">
<h3 id="_background"><a class="anchor" href="#_background"></a>Background</h3>
<div class="paragraph">
<p>The following diagram illustrates how the parent decisions affect an outcome of the chosen deployment strategy.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/decision-tree.drawio.svg" alt="decision tree.drawio">
</div>
<div class="title">Figure 1. Decision tree</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">In-place upgrade of major version</dt>
<dd>
<p>How upgrades of major versions are conducted by the user.
In-place upgrades refer to the ability of the operator to perform an upgrade of a major version on the same instance.
The alternative is to make the initial version selector immutable and require the user to order a new service instance with the new version and let them perform the data migration and upgrade themselves.
This "no-upgrade" approach may be necessary anyway in case PostgreSQL requires where in-place upgrades can&#8217;t be done without user involvement anyway.</p>
<div class="paragraph">
<p>All deployment strategies expect a downtime.
There&#8217;s no requirement that says that major version upgrades are performed without downtime.</p>
</div>
<div class="paragraph">
<p>In case of no-upgrade path, it may be worth considering to offer a mechanism to the user to automatically copy the data to the new instance, provided the data doesn&#8217;t need to be upgraded by the user (for example schema migrations).
But this decision is not relevant here.</p>
</div>
</dd>
<dt class="hdlist1">Handle breaking changes</dt>
<dd>
<p>If API changes should be handled in Helm charts or CRD API specs.
The operator can handle API changes if running the next major version of PostgreSQL doesn&#8217;t affect older running instances that aren&#8217;t upgraded yet.
Depending on deployment strategy, API changes can&#8217;t be safely performed without measures that make it possible to run not-yet-upgraded instances.
Especially CRD API changes are very difficult to manage, since only 1 version of CRD is stored in etcd, see more in this <a href="https://www.faun.dev/c/stories/dineshparvathaneni/kubernetes-crd-versioning-for-operator-developers/">blog</a>.</p>
</dd>
<dt class="hdlist1">Deployment strategy</dt>
<dd>
<p>So far 2 strategies have been more closely looked at: Helm and foreign Postgres Operators.</p>
<div class="paragraph">
<p>A foreign operator installs and maintains PostgreSQL deployments.
One such operator is the <a href="https://github.com/CrunchyData/postgres-operator">Postgres Operator from Crunchy Data</a>, but there&#8217;s also <a href="https://github.com/zalando/postgres-operator">Postgres Operator from Zalando</a>.
While these operators might be very good at what they do, the challenge is in AppCat&#8217;s requirement that users can choose their maintenance and upgrade window.
It has to be anticipated that upstream breaking API changes will happen at some point in the future.
However, multiple versions of the same CRD cannot run on the same Kubernetes API server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
From now on <code>PGO</code> is used to refer to a foreign Postgres Operator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the Helm strategy, active upstream Helm charts are used to deploy the instance.
The chart chosen shall fulfill all requirements that are relevant for running a VSHN-opinionated managed service.
If none exist that are suitable, a fork or own chart may be necessary.</p>
</div>
<div class="paragraph">
<p>Helm charts usually deploy native <code>Deployments</code> or <code>StatefulSets</code> and are thus much easier to handle since they&#8217;re not abstracted behind an additional CRD.
However, a chart can still do changes that are effectively backwards-incompatible, requiring manual user interaction.
One such example would be to rename the <code>PersistentVolumeClaim</code> template in a <code>StatefulSet</code>, which would require a sophisticated data migration.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_breaking_change_scenario_example"><a class="anchor" href="#_breaking_change_scenario_example"></a>Breaking Change Scenario Example</h3>
<div class="paragraph">
<p>Let&#8217;s consider the deployment strategy with a foreign PGO and the worst-case.
Starting situation is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Suppose PGO in v1 supports PostgreSQL up until version 14.</p>
</li>
<li>
<p>Suppose PostgreSQL v15 is released that requires user to upgrade their schemas.</p>
</li>
<li>
<p>PGO in v2 is released that supports PostgreSQL v15, but not v14 anymore.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We have effectively 3 breaking changes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>PGO v2 API spec changed</p>
</li>
<li>
<p>PostgreSQL v15 requires data upgrade</p>
</li>
<li>
<p>PGO v2 doesn&#8217;t support PostgreSQL v14</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This means:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We can&#8217;t upgrade to PostgreSQL v15 without upgrading PGO to v2.</p>
</li>
<li>
<p>We can&#8217;t upgrade to PGO v2 without having the possibility to run PostgreSQL v14 for the users that aren&#8217;t ready for v15&#8217;s data migration.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The chance of such a constellation is slim, but not impossible and VSHN already experienced such scenarios.
Even if PostgreSQL v15 doesn&#8217;t require a user data migration, there needs to be an answer how to deal with upstream changes that result in some kind of impasse.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proposals"><a class="anchor" href="#_proposals"></a>Proposals</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_proposal_1"><a class="anchor" href="#_proposal_1"></a>Proposal 1</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Operator</dt>
<dd>
<p>in-place upgrades, handle breaking changes</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To deal with backwards-incompatible changes, each major PostgreSQL version supported will run on a dedicated <a href="https://kb.vshn.ch/app-catalog/reference/glossary.html#_service_location">service cluster</a>.
This is to ensure that the old CRD version can still run on non-upgraded PostgreSQL instances so that old versions can be running until their EOL date.
However, this massively increases the running costs.</p>
</div>
<div class="paragraph">
<p>Whenever the user chooses the next major version, a new deployment is started in the service cluster that runs the new version, and an automatic data import is attempted from the old service cluster to the new one.</p>
</div>
<div class="paragraph">
<p>This operator (appcat-service-postgresql) abstracts and deploys a PGO resource and possibly glues it with additional resources, for example Prometheus rules.</p>
</div>
</div>
<div class="sect2">
<h3 id="_proposal_2"><a class="anchor" href="#_proposal_2"></a>Proposal 2</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Helm</dt>
<dd>
<p>in-place upgrades, handle breaking changes</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>As long as the there are no breaking changes, the upstream chart updates are followed and applied to all existing instances.</p>
</div>
<div class="paragraph">
<p>To deal with backward-incompatible changes, each major version supported will run on the last working chart version for that major version.
This allows to skip the chart upgrade on old major versions, while the next major version will feature the changed Helm chart version.</p>
</div>
<div class="paragraph">
<p>In the exceptional event that a critical change needs to be backported to an older major version, it should be easily possible to switch to a fork that contains the change on the running instances.
The same idea can be applied if there&#8217;s no PostgreSQL major version coming up in the near future.</p>
</div>
<div class="paragraph">
<p>If the upstream chart is still relevant for future major versions, it can be switched back to it from the fork, so that the fork is eventually not needed anymore.
However, this requires some kind of migrations that the Operator could do between the chart versions.</p>
</div>
<div class="paragraph">
<p>This operator (appcat-service-postgresql) configures Helm values and deploys a chart using the <a href="https://github.com/crossplane-contrib/provider-helm">Crossplane Helm Provider</a> and possibly glues it with additional resources, for example Prometheus rules.</p>
</div>
</div>
<div class="sect2">
<h3 id="_proposal_3"><a class="anchor" href="#_proposal_3"></a>Proposal 3</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Operator</dt>
<dd>
<p>in-place upgrades, don&#8217;t handle breaking changes</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This approach deals with backwards-incompatible changes by forcing a mandatory maintenance window upon the instances.
It works only if the new API specs support all currently running major versions of PostgreSQL.</p>
</div>
<div class="paragraph">
<p>In the maintenance window, the new version of the CRD is rolled out in a way so that the officially supported upgrade path is applied in an automated fashion.
This could mean a complete backup and restore operation for every single instance until all instances are upgraded.</p>
</div>
<div class="paragraph">
<p>If the new API design doesn&#8217;t support a still-running major version anymore, that upgrade has to be delayed until all instances are running on a major PostgreSQL version that is supported by the new PGO version.</p>
</div>
</div>
<div class="sect2">
<h3 id="_proposal_4"><a class="anchor" href="#_proposal_4"></a>Proposal 4</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Helm</dt>
<dd>
<p>in-place upgrades, don&#8217;t handle breaking changes</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This proposal is similar to Proposal 2, except it continues any forks for upcoming major versions as well, without switching back to the upstream chart.
In other words, the upstream breaking change isn&#8217;t applied.
That means maintaining the fork in its own or constantly backport upstream changes in a way that doesn&#8217;t break existing instances.</p>
</div>
</div>
<div class="sect2">
<h3 id="_proposal_5"><a class="anchor" href="#_proposal_5"></a>Proposal 5</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Helm</dt>
<dd>
<p>no upgrades, handle breaking changes</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Like in Proposal 2, but data needs to be migrated.</p>
</div>
</div>
<div class="sect2">
<h3 id="_proposal_6"><a class="anchor" href="#_proposal_6"></a>Proposal 6</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Operator</dt>
<dd>
<p>no upgrades, handle breaking changes</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Similar to Proposal 5, the major version is immutable upon first provisioning.
And similar to Proposal 1, the instances are running on dedicated service clusters to separate different CRD versions and API.</p>
</div>
</div>
<div class="sect2">
<h3 id="_proposal_7"><a class="anchor" href="#_proposal_7"></a>Proposal 7</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Helm</dt>
<dd>
<p>no upgrades, don&#8217;t handle breaking changes</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This proposal is similar to Proposal 4, except it continues any forks for upcoming major versions as well, without switching back to the upstream chart.
In other words, the upstream breaking change isn&#8217;t applied.
That means maintaining the fork in its own or constantly backport upstream changes in a way that doesn&#8217;t break existing instances.</p>
</div>
<div class="paragraph">
<p>Data needs to be migrated from the previous instance to the new instance.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_decision"><a class="anchor" href="#_decision"></a>Decision</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Proposal 2: Helm with in-place upgrades and handle breaking changes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rationale"><a class="anchor" href="#_rationale"></a>Rationale</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Although Helm charts may also break and have their limitations, there are a lot less moving parts when going the Helm path compared to foreign Operators.
In the end Helm is a client-side application that leaves any resource alone if not interacted using Helm.
This keeps the dependency on 3rd party technologies manageable.</p>
</div>
<div class="paragraph">
<p>The only reliable and future-proof option to isolate CRD changes in PGO is to separate them in service clusters.
This results in an inherently more complex system overall.
Moreover that is also going to be more expensive in regards to compute resources that would have to be passed on the paying customer.</p>
</div>
<div class="paragraph">
<p>In any case, the idea of using a foreign Operator reveals a number of challenges and scenarios when running instances in the dozens.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_abandoned_ideas"><a class="anchor" href="#_abandoned_ideas"></a>Abandoned Ideas</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_vcluster"><a class="anchor" href="#_vcluster"></a>vcluster</h3>
<div class="paragraph">
<p>There exists a project called <a href="https://github.com/loft-sh/vcluster">virtual cluster</a> that could help isolating CRDs per major version.
However this method doesn&#8217;t really work.</p>
</div>
<div class="paragraph">
<p>The pods scheduled in vcluster are all scheduled in the same namespace on the host as vcluster is in.
Considering dozens of instances in vcluster even separated in namespaces, there could be hundreds of pods in a single namespace on the host cluster.
This is not only an operational nightmare, but also they&#8217;re not isolated enough for multi-tenancy.</p>
</div>
<div class="paragraph">
<p>Deploying vcluster per instance creates a large amount of pods, since each vcluster also runs 2 pods for its internal services (API server, DNS etc.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_operator_without_upgrade_path_and_api_handling"><a class="anchor" href="#_operator_without_upgrade_path_and_api_handling"></a>Operator without upgrade path and API handling</h3>
<div class="paragraph">
<p>In the diagram above there&#8217;s an empty box labelled <code>not possible</code> for a leaf path.
This method is not possible.
Like in Proposal 3 the PGO CRD API would have to be enforced to all users simultaneously.
However, this combination requires a new service instance, but without the user&#8217;s involvement, what is the new name going to be?
One could argue to generate a new name, but then the user is still required to configure the application to use the new credentials and endpoint.
It&#8217;s unreasonable to think that every user will be ready to reconfigure the application in a coordinated maintenance window to reduce downtime as much as possible.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright Â© VSHN 2021 â€“ All Rights Reserved. <a href="https://vshn.ch/en/privacy-policy/">Privacy Policy</a>, <a href="https://vshn.ch/en/imprint/">Imprint</a>, and <a href="https://vshn.ch/en/contact/">Contact</a>.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
  </body>
</html>
